<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="RESTful API Authentication : A gem which implements a standard api_key / secret authentication system for your Ruby on Rails RESTful web services." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>RESTful API Authentication</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/davejkiger/restful_api_authentication">View on GitHub</a>

          <h1 id="project_title">RESTful API Authentication</h1>
          <h2 id="project_tagline">A gem which implements a standard api_key / secret authentication system for your Ruby on Rails RESTful web services.</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/davejkiger/restful_api_authentication/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/davejkiger/restful_api_authentication/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p>With most RESTful Web API's, it is important to know which app is using your resources and that only the apps you allow access those resources. This gem allows you to easily add this layer of authentication to any Rails RESTful resource you want, and it even includes protection against various forms of attack.</p>

<p>Go here to read a more lengthy description of the problem this gem is attempting to solve: <a href="http://www.djkiger.com/?p=41">Authentication of a Ruby on Rails RESTful Web API / Service</a></p>

<h2>Requirements</h2>

<ol>
<li>Rails 3.2.0+</li>
<li>ActiveRecord database (sqlite, MySQL, etc.)</li>
</ol><h2>Dependencies</h2>

<ol>
<li>Rails 3.2.0+</li>
<li>UUID Gem 2.3.5+</li>
<li>Chronic Gem 0.6.7+</li>
</ol><h2>Installation</h2>

<p>Add this line to your application's Gemfile:</p>

<pre><code>gem 'restful_api_authentication'
</code></pre>

<p>And then execute:</p>

<pre><code>$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre><code>$ gem install restful_api_authentication
</code></pre>

<p>Run Rails generator:</p>

<pre><code>$ rails g restful_api_authentication:install
</code></pre>

<p>Run the migration task:</p>

<pre><code>$ rake db:migrate
</code></pre>

<p>Update the configuration (if you like) by editing the <code>config/restful_api_authentication.yml</code> file.</p>

<h2>Usage</h2>

<h3>How It Works From A Client's Perspective</h3>

<p>Before anyone can use a resource which is protected using this gem, that person/app must have a valid API key and secret. These are generated and stored as a RestClient model in your app. The easiest way to generate this is to use the Rails console:</p>

<div class="highlight">
<pre><span class="n">new_app</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"My New App"</span><span class="p">,</span> <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">"This is my new application that will access my RESTful API."</span><span class="p">)</span>
<span class="n">new_app</span><span class="o">.</span><span class="n">api_key</span>
<span class="n">new_app</span><span class="o">.</span><span class="n">secret</span>
</pre>
</div>


<p>In order to authenticate with your web service, the new application must include the following HTTP headers with each request:</p>

<ul>
<li>x-timestamp</li>
<li>x-api-key</li>
<li>x-signature</li>
</ul><p>The x-timestamp should be the date and time the request is sent. It should be in UTC time and be formatted as "YYYY-MM-DD HH:MM:SS UTC". For example: <code>2012-03-31 15:37:32 UTC</code></p>

<p>The x-api-key should be the same as the API key generated above. It should look something like <code>0f0721f0-5cc9-012f-c884-68a86d3dfd0</code>.</p>

<p>The x-signature is generated by concatenating the secret generated above, the API request URL, and the x-timestamp into a single string and then using the SHA256 hash algorithm to generate a hash of this string. The x-signature is this hash.</p>

<p>Here is an example in Ruby code using the HTTParty gem:</p>

<div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'httparty'</span>
<span class="nb">require</span> <span class="s1">'digest/sha2'</span>

<span class="k">class</span> <span class="nc">MyTestApi</span>
  <span class="kp">include</span> <span class="no">HTTParty</span>

  <span class="no">API_KEY</span> <span class="o">=</span> <span class="s2">"e4a80df0-5cca-012f-c884-68a86d3dfd02"</span>
  <span class="no">SECRET</span> <span class="o">=</span> <span class="s2">"473287f8298dba7163a897908958f7c0eae733e25d2e027992ea2edc9bed2fa8"</span>

  <span class="k">def</span> <span class="nf">auth_headers</span><span class="p">(</span><span class="n">request_uri</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">strftime</span> <span class="s2">"%Y-%m-%d %H:%M:%S UTC"</span>
    <span class="n">signature_string</span> <span class="o">=</span> <span class="no">SECRET</span> <span class="o">+</span> <span class="n">request_uri</span> <span class="o">+</span> <span class="n">timestamp</span>
    <span class="n">digest</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span><span class="o">.</span><span class="n">new</span> <span class="o">&lt;&lt;</span> <span class="n">signature_string</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">digest</span><span class="o">.</span><span class="n">to_s</span>
    <span class="p">{</span> <span class="s2">"x-api-key"</span> <span class="o">=&gt;</span> <span class="no">API_KEY</span><span class="p">,</span> <span class="s2">"x-timestamp"</span> <span class="o">=&gt;</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s2">"x-signature"</span> <span class="o">=&gt;</span> <span class="n">signature</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">authenticate_test</span>
    <span class="n">request_uri</span> <span class="o">=</span> <span class="s2">"https://api.mywebservice.com/help/authenticate"</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">request_uri</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:headers</span> <span class="o">=&gt;</span> <span class="n">auth_headers</span><span class="p">(</span><span class="n">request_uri</span><span class="p">)</span> <span class="p">})</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="n">api</span> <span class="o">=</span> <span class="no">MyTestApi</span><span class="o">.</span><span class="n">new</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">authenticate_test</span>
<span class="nb">puts</span> <span class="n">result</span><span class="o">.</span><span class="n">inspect</span>
</pre>
</div>


<h3>Configuration</h3>

<p>In the <code>config/restful_api_authentication.yml</code> file you will find several things that you can change. The defaults are usually fine for most cases.</p>

<p><strong>Verbose Error Messages (&gt;= 0.2.0)</strong></p>

<p>By default, the standard response to any authentication error is "not authorized". However, more meaningful explanations of why authentication is failing can be sent by adding the following to the <code>config/restful_api_authentication.yml</code> file:</p>

<pre><code>verbose_errors: true
</code></pre>

<h3>Requiring Authentication</h3>

<p>To require authentication for a specific resource (controller) of your RESTful web service, add this at the top of your controller just under where you open the controller class:</p>

<div class="highlight">
<pre><span class="kp">include</span> <span class="no">RestfulApiAuthentication</span>
<span class="n">respond_to</span> <span class="ss">:json</span><span class="p">,</span> <span class="ss">:xml</span>
<span class="n">before_filter</span> <span class="ss">:authenticated?</span>
</pre>
</div>


<p>If you want to protect your entire web service, add those same lines to your ApplicationController class.</p>

<p>If the headers are not provided or the application fails to authenticate, your web service will deliver a 401 Unauthorized response.</p>

<h3>Master Authentication</h3>

<p>Some web services might require an extra bit of security (creating new RestClients or managing User records). In these cases, you can require "master" authorization. Then, any RestClient with the is_master attribute set to true can use the resources but the others cannot.</p>

<p>Assuming you have authentication setup in your application controller, in the controller that requires master authentication:</p>

<div class="highlight">
<pre><span class="n">skip_before_filter</span> <span class="ss">:authenticated?</span>
<span class="n">before_filter</span> <span class="ss">:authenticated_master?</span>
</pre>
</div>


<h2>Contributing</h2>

<ol>
<li>Fork it</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Added some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create new Pull Request</li>
</ol>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">RESTful API Authentication maintained by <a href="https://github.com/davejkiger">davejkiger</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-20285212-2");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>


  </body>
</html>
